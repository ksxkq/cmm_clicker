# Task List MVP v1（真实任务体验）

更新时间：2026-02-27

## 1. 目标

1. 让用户可以在应用内管理真实任务，而不是仅运行固定 demo。
2. 打通最小闭环：新建任务 -> 编辑动作 -> 保存 -> 任务列表运行 -> 查看最近运行结果。
3. 为后续导入与迁移落地提供统一任务容器（`TaskBundle`）。

## 2. 当前实现

文件：

1. `app/src/main/java/com/ksxkq/cmm_clicker/feature/task/TaskRepository.kt`
2. `app/src/main/java/com/ksxkq/cmm_clicker/ui/MainActivity.kt`
3. `app/src/main/java/com/ksxkq/cmm_clicker/ui/MainTabsRoute.kt`
4. `app/src/main/java/com/ksxkq/cmm_clicker/ui/TaskTabScreen.kt`
5. `app/src/main/java/com/ksxkq/cmm_clicker/ui/ConsoleTabScreen.kt`
6. `app/src/main/java/com/ksxkq/cmm_clicker/ui/MainUiComponents.kt`
7. `app/src/main/java/com/ksxkq/cmm_clicker/accessibility/TaskControlPanelGlobalOverlay.kt`

能力：

1. `LocalFileTaskRepository`：本地 JSON 持久化，支持任务 CRUD 与运行信息更新。
2. 任务列表页（`任务` Tab）：
   - Shortcuts 风格“快捷指令库”卡片布局
   - 首页采用 iOS 风格底部导航结构（任务/控制台）
   - 已接入 `Scaffold` 安全区内边距，适配 Android 14 边到边场景
   - 新建任务（默认模板 `start -> click -> end`）
   - 搜索任务（名称/ID）
   - 分段筛选（全部/最近运行/最近编辑）
   - 卡片操作：点击卡片直接进入浮窗编辑（无“选中”交互）
   - 运行使用圆形播放 icon 按钮（固定卡片右下角）
   - 卡片右上角提供圆形更多按钮，`复制/重命名/删除` 收纳到菜单
   - 图标改为标准库（Material Icons Extended），避免手绘图标一致性问题
   - 删除二次确认与重命名弹窗
3. 动作详情浮窗：
   - 由 AccessibilityService 承载的全局浮窗（`TYPE_ACCESSIBILITY_OVERLAY`），可在其它 App 页面编辑
   - 统一使用公共弹窗容器：头部标题/菜单 action/底部操作区可按场景配置
   - 浮窗 UI 全量使用 Compose Material3 组件，并通过 `CmmClickerTheme + AppThemeMode` 与首页保持同一主题效果
   - 浮窗改为“全屏弹窗层 + 底部内容面板”，禁止拖动位置，交互更稳定
   - 显示时带背景渐暗动画与底部上滑动画，强化弹窗语义
   - 点击内容外区域可关闭浮窗，交互行为与常规弹窗一致
   - 关闭时带退出动画（背景淡出 + 面板下滑），再执行窗口移除
   - 背景遮罩覆盖状态栏区域，且保持半透明，不使用不透明灰底
   - 默认仅展示动作列表摘要（不铺满参数）
   - 顶部提供“查看预览/隐藏预览”按钮（黑白统一样式），预览支持图形连线与文本连线
   - 动作列表内支持 jump 连接线（同 flow）用于快速识别跳转目标
   - 点击动作后进入“动作编辑浮窗”
4. Jump 设置规则：
   - 跳转语义来自 `NodeKind.JUMP`，不是 `ActionType=jump`
   - 通过 `targetFlowId + targetNodeId` 指向目标节点（支持跨 flow）
5. 任务列表显示：
   - 更新时间
   - 最近运行时间
   - 最近运行状态
   - 最近运行摘要
   - 搜索（按任务名或 taskId）
   - 分段筛选（全部/最近运行/最近编辑）
   - 删除任务二次确认弹窗
6. 编辑器联动：
   - 进入运行/编辑动作前加载对应 `TaskBundle` 作为当前任务上下文
   - 编辑自动保存（防丢）
   - 手动“保存任务”按钮
7. 控制台联动：
   - 运行按钮语义改为“运行当前任务”。
8. 页面结构：
   - `MainActivity` 仅负责状态与回调分发
   - Tab 页面与 UI 组件拆分到独立文件，便于维护与后续继续 ViewModel 化
9. 全局操作面板（任意 App 界面）：
   - 形态：可拖动矩形工具条（非弹窗卡片）
   - 四按钮：`设置/录制/开始/移除`（仅 icon 展示）
   - `设置`：通过独立 `addView` 打开任务列表浮窗（非面板窗口内切换）
   - 设置页过渡：scrim 渐入 + 列表面板自底部上滑，关闭时反向动画
   - `录制`：全屏录制层采集用户手势，自动落库为 `CLICK/RECORD` 动作
   - `开始`：执行最近启动任务（无记录时回退到当前选择任务）
   - `移除`：退出动画后移除面板
   - 显示动画：渐隐 + 轻微缩放 + 轻微位移
   - 关闭动画：反向渐隐 + 轻微缩放 + 轻微位移
   - 窗口尺寸：工具条模式严格按内容 `wrap_content` 渲染（不铺满）
   - 视觉约束：工具条模式无额外半透明灰底层
   - 拖拽行为：支持在屏幕内拖拽定位，返回工具条后保持当前位置
   - 设置弹窗关闭后直接回到现有工具条状态，不重新播放入场动画
   - 设置页任务卡片点击后进入同窗编辑路由（不再额外 `addView`）：任务列表 -> 动作列表 -> 动作详情（堆叠转场）
   - 设置页堆叠转场按“整页层”执行：标题栏与内容区一起参与进退场动画
   - 堆叠视觉强化：动作层/详情层使用不同 inset 卡片层级，底层同步缩放与位移，增强“页面压栈”感知
   - 设置页堆叠动效参数与首页编辑器统一为 spring 上滑/回落节奏，避免两处动效观感不一致
   - 设置页不再使用“固定外壳 + 内部切换”；改为每一层页面独立卡片参与堆叠，层级轮廓会随路由变化
   - 三层堆叠时底层继续退让：第 3 层出现会触发第 1/2 层额外缩放、位移和变暗，不再只看到“新层覆盖旧层”
   - 堆叠语义对齐 iOS：新出现的上层页面保持主体尺寸，主要由下层页面执行缩小/退让动画
   - 首页编辑浮窗与设置浮窗共用同一套堆叠参数（`OverlayStackMotion`），两条编辑入口的动画观感保持一致
   - 三层堆叠的顶部露出高度已回调到统一规范，避免第 3 层露出过多
   - 三层堆叠强化“第二层可见带”：通过增大 `SECOND/THIRD` 顶部间距差与下层向下退让，避免第三层完全遮挡第二层
   - 设置浮窗可见堆叠深度限制为 2：第 3 级页面出现时隐藏最底层，仅显示“上一层 + 当前层”，避免多层叠加导致信息噪声
   - 视觉细化：`2->3` 时中间层不再缩放（保持主体高度感），`1->2` 通过底层退让增强露出，不依赖压缩上层高度
   - `1->2` 堆叠保证首层顶部露出带：采用轻缩放 + 轻微上移 + 第二层固定顶部 inset，避免“切页后首层完全不可见”
   - `2->3` 迭代规则：新页面进入时占据上一层位置，上一层后移到背景位置；不再出现“新层直接在更低位置覆盖”的非迭代感
   - 底部露出收敛：降低堆叠缩放幅度，减少卡片底部缩窄和空隙
   - 最新参数：为增强层级感，后层缩放恢复到 `0.965`；`2->3` 时背景层位置回到 `topInset=0`，新层仍保持前景 `topInset=18`
   - 露出带增强：前景 `topInset` 提升到 `24dp`，下层顶部露出更明显
   - `2->3` 位移平滑：中间层从前景位退到背景位时使用 spring 动画，避免“往上顶一下”的突兀跳变
   - 堆叠常量命名已收敛到“两层可见”语义，避免继续出现“第三层参数”误导
   - inset 动画加了非负保护，避免深层打开时出现 `Padding must be non-negative` 崩溃
   - 设置弹窗关闭时，操作面板采用常驻节点显隐，避免返回工具条瞬间闪烁
   - 设置弹窗内部空白区点击会被内容容器消费，不会冒泡到遮罩导致误返回/误关闭
   - 设置弹窗遮罩改为独立底层点击区域，确保任务列表与编辑页可正常滚动
   - 任务设置页为 `TaskLibraryPanel` 提供独立纵向滚动承载层，任务数量较多时仍可滑动浏览
   - 动作列表与动作详情顶部提供返回按钮，可逐级返回到任务列表
   - 控制台页提供“打开操作面板/关闭操作面板”入口，用于启动全局浮窗

## 3. 当前限制

1. 持久化当前为文件 JSON，尚未升级到 Room（后续可平滑替换）。
2. 任务列表当前尚未支持批量操作（批量删除/批量运行）。
3. 任务模板目前仅用于研发阶段，正式上线可关闭默认模板创建。
4. 当前主页面不提供普通编辑入口，任务编辑统一走全局浮窗。
5. 目前仍是 Activity 内状态持有，下一步再下沉到独立 ViewModel/RouteState。
6. 录制当前为 MVP：单次手势自动追加，不含连续录制会话与录制后批量确认。

## 4. 下一步

1. 任务库第二版：卡片信息层级优化、上下文菜单与批量操作。
2. 运行结果可展开详情。
3. 任务批量操作（批量选择、批量删除）与空态优化。
4. 任务稳定后再接入旧备份导入和 schema 迁移链。
5. 操作面板下一步补齐录制动作的“保存后立即编辑”与更细粒度录制控制。
